[
    {
        "name": "Arena",
        "trigger": "Arena",
        "level_nid": "DEBUG",
        "condition": "True",
        "commands": [
            [
                "comment",
                [
                    "# GBA style arena"
                ]
            ],
            [
                "transition",
                [
                    "Close"
                ]
            ],
            [
                "comment",
                [
                    "# Determine Enemy's class, level, and item, along with associated Wager"
                ]
            ],
            [
                "level_var",
                [
                    "EntrantClass",
                    "DB.classes.get(unit.klass)"
                ]
            ],
            [
                "level_var",
                [
                    "ArenaEnemyKlassList",
                    "[k.nid for k in DB.classes if 'ArenaIgnore' not in k.tags and k.tier == game.level_vars['EntrantClass'].tier]"
                ]
            ],
            [
                "level_var",
                [
                    "KlassRNG",
                    "game.get_random(0, len(game.level_vars['ArenaEnemyKlassList']) - 1)"
                ]
            ],
            [
                "level_var",
                [
                    "ArenaEnemyKlass",
                    "game.level_vars['ArenaEnemyKlassList'][game.level_vars['KlassRNG']]"
                ]
            ],
            [
                "level_var",
                [
                    "low_level",
                    "max(1, unit.level - 4)"
                ]
            ],
            [
                "level_var",
                [
                    "high_level",
                    "min(DB.classes.get(game.level_vars['ArenaEnemyKlass']).max_level, unit.level + 4)"
                ]
            ],
            [
                "level_var",
                [
                    "ArenaEnemyLevel",
                    "game.get_random(game.level_vars['low_level'], game.level_vars['high_level'])"
                ]
            ],
            [
                "level_var",
                [
                    "ArenaPercent",
                    "(game.level_vars['ArenaEnemyLevel'] - game.level_vars['low_level']) / float(game.level_vars['high_level'] - game.level_vars['low_level'])"
                ]
            ],
            [
                "level_var",
                [
                    "ArenaWager",
                    "int(min(550 + game.level_vars['ArenaPercent'] * (1100 - 550), game.get_money()))"
                ]
            ],
            [
                "level_var",
                [
                    "ArenaWexpGain",
                    "DB.classes.get(game.level_vars['ArenaEnemyKlass']).wexp_gain"
                ]
            ],
            [
                "level_var",
                [
                    "ArenaItemDict",
                    "{'Sword': 'Iron Sword', 'Lance': 'Iron Lance', 'Axe': 'Iron Axe', 'Bow': 'Iron Bow', 'Staff': 'Heal', 'Light': 'Lightning', 'Anima': 'Fire', 'Dark': 'Flux'}"
                ]
            ],
            [
                "level_var",
                [
                    "ArenaWexpGainMaxNid",
                    "max(game.level_vars['ArenaWexpGain'].items(), key=lambda x: x[1].wexp_gain)[0]"
                ]
            ],
            [
                "level_var",
                [
                    "ArenaItem",
                    "game.level_vars['ArenaItemDict'][game.level_vars['ArenaWexpGainMaxNid']]"
                ]
            ],
            [
                "comment",
                [
                    "# Actually instantiate unit"
                ]
            ],
            [
                "make_generic",
                [
                    "",
                    "{var:ArenaEnemyKlass}",
                    "{var:ArenaEnemyLevel}",
                    "enemy"
                ]
            ],
            [
                "add_unit",
                [
                    "{created_unit}",
                    "{unit}",
                    "immediate",
                    "closest"
                ]
            ],
            [
                "give_item",
                [
                    "{created_unit}",
                    "{var:ArenaItem}",
                    "no_banner"
                ]
            ],
            [
                "comment",
                [
                    "# Now move to Arena"
                ]
            ],
            [
                "change_background",
                [
                    "Arena"
                ]
            ],
            [
                "draw_overlay_sprite",
                [
                    "Dialogue",
                    "menu_bg_clear",
                    "-4,8",
                    "0"
                ]
            ],
            [
                "draw_overlay_sprite",
                [
                    "ArenaPortrait",
                    "arena_portrait",
                    "4,4",
                    "1"
                ]
            ],
            [
                "table",
                [
                    "GoldDisplay",
                    "[game.get_money()]",
                    "",
                    "",
                    "60",
                    "right",
                    "funds_display",
                    "",
                    "center",
                    "expression"
                ],
                [
                    "GoldDisplay",
                    "[game.get_money()]",
                    "",
                    "",
                    "60",
                    "right",
                    "funds_display",
                    "",
                    "center",
                    "FLAG(expression)"
                ]
            ],
            [
                "comment",
                [
                    "# Fade to arena background"
                ]
            ],
            [
                "transition",
                [
                    "open"
                ]
            ],
            [
                "if",
                [
                    "unit.get_weapon()"
                ]
            ],
            [
                "choice",
                [
                    "ArenaChoice",
                    "Would you like to wager {var:ArenaWager} gold?",
                    "Yes,No",
                    "",
                    "horizontal"
                ]
            ],
            [
                "if",
                [
                    "game.game_vars['ArenaChoice'] == 'Yes'"
                ]
            ],
            [
                "sound",
                [
                    "GoldExchange"
                ]
            ],
            [
                "give_money",
                [
                    "{eval:-game.level_vars['ArenaWager']}",
                    "no_banner"
                ]
            ],
            [
                "speak",
                [
                    "",
                    "Good luck. Don't get yourself killed.",
                    "60,8",
                    "160",
                    "clear"
                ]
            ],
            [
                "transition",
                [
                    "close"
                ]
            ],
            [
                "interact_unit",
                [
                    "{unit}",
                    "{created_unit}",
                    "",
                    "",
                    "20",
                    "arena",
                    "force_animation"
                ]
            ],
            [
                "if",
                [
                    "unit2.is_dying or unit2.dead"
                ]
            ],
            [
                "transition",
                [
                    "open"
                ]
            ],
            [
                "speak",
                [
                    "",
                    "So you won, eh? Here's your prize. {eval:2*game.level_vars['ArenaWager']} gold.",
                    "60,8",
                    "160",
                    "clear"
                ]
            ],
            [
                "sound",
                [
                    "GoldExchange"
                ]
            ],
            [
                "give_money",
                [
                    "{eval:2*game.level_vars['ArenaWager']}",
                    "no_banner"
                ],
                [
                    "{eval:2*game.level_vars['ArenaWager']}",
                    "FLAG(no_banner)"
                ]
            ],
            [
                "wait",
                [
                    "200"
                ]
            ],
            [
                "end",
                []
            ],
            [
                "has_attacked",
                [
                    "{unit}"
                ]
            ],
            [
                "else",
                []
            ],
            [
                "speak",
                [
                    "",
                    "What are you wasting my time for?",
                    "60,8",
                    "160",
                    "clear"
                ]
            ],
            [
                "end",
                []
            ],
            [
                "else",
                []
            ],
            [
                "speak",
                [
                    "",
                    "What! You don't have a weapon! Get out of here!",
                    "60,8",
                    "160",
                    "clear"
                ]
            ],
            [
                "end",
                []
            ],
            [
                "transition",
                [
                    "close"
                ]
            ],
            [
                "comment",
                [
                    "# Clean up"
                ]
            ],
            [
                "change_background",
                []
            ],
            [
                "remove_unit",
                [
                    "{created_unit}",
                    "immediate"
                ]
            ],
            [
                "rmtable",
                [
                    "GoldDisplay"
                ]
            ],
            [
                "remove_overlay_sprite",
                [
                    "Dialogue"
                ]
            ],
            [
                "remove_overlay_sprite",
                [
                    "ArenaPortrait"
                ]
            ],
            [
                "transition",
                [
                    "open"
                ]
            ]
        ],
        "only_once": false,
        "priority": 20
    }
]